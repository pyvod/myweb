<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šç­çº§ä½œä¸šç®¡ç†ç³»ç»Ÿ - æ•™å¸ˆç«¯</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #e74c3c);
            color: white;
            padding: 25px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.2em;
            margin-bottom: 5px;
        }

        .header .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .status-bar {
            background: #f8f9fa;
            padding: 12px 25px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sync-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #28a745;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .controls {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
        }

        .content {
            padding: 25px;
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 25px;
            min-height: 600px;
        }

        .editor-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }

        .preview-section {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            max-height: 800px;
            overflow-y: auto;
        }

        .section-title {
            font-size: 1.3em;
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }

        .class-selector {
            margin-bottom: 20px;
        }

        .grade-tabs {
            display: flex;
            margin-bottom: 12px;
            border-bottom: 2px solid #e9ecef;
        }

        .grade-tab {
            padding: 8px 16px;
            background: #f8f9fa;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .grade-tab.active {
            background: white;
            border-bottom-color: #007bff;
            color: #007bff;
        }

        .class-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 8px;
            max-height: 150px;
            overflow-y: auto;
            padding: 8px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            background: white;
        }

        .class-btn {
            padding: 6px 4px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: bold;
            font-size: 0.85em;
        }

        .class-btn.active {
            border-color: #007bff;
            background: #007bff;
            color: white;
        }

        .subject-selector {
            margin-bottom: 20px;
        }

        .subject-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .subject-btn {
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: bold;
        }

        .subject-btn.active {
            border-color: #007bff;
            background: #007bff;
            color: white;
        }

        .editor-container {
            margin-bottom: 20px;
        }

        .editor-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }

        .homework-editor {
            width: 100%;
            height: 250px;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            font-size: 1em;
            line-height: 1.5;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        .homework-editor:focus {
            outline: none;
            border-color: #007bff;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .preview-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            border-left: 5px solid #3498db;
            transition: all 0.3s ease;
        }

        .preview-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 12px rgba(0,0,0,0.15);
        }

        .preview-header {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 12px;
            border-radius: 6px 6px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-header h3 {
            font-size: 1.1em;
            margin: 0;
        }

        .preview-content {
            padding: 15px;
            min-height: 60px;
        }

        .preview-text {
            font-size: 1em;
            line-height: 1.5;
            color: #2c3e50;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .empty-preview {
            color: #7f8c8d;
            font-style: italic;
            text-align: center;
            padding: 15px;
        }

        .last-updated {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
            text-align: center;
            color: #6c757d;
            font-size: 0.9em;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            background: #28a745;
            color: white;
            border-radius: 6px;
            box-shadow: 0 3px 12px rgba(0,0,0,0.2);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
            max-width: 350px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: #dc3545;
        }

        .notification.warning {
            background: #ffc107;
            color: #212529;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 1.3em;
            margin-bottom: 15px;
            color: #2c3e50;
            text-align: center;
        }

        .config-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-label {
            font-weight: bold;
            color: #2c3e50;
        }

        .form-input {
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 0.95em;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #007bff;
        }

        .form-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 15px;
        }

        .modal-tabs {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 15px;
        }

        .modal-tab {
            padding: 8px 16px;
            background: #f8f9fa;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .modal-tab.active {
            background: white;
            border-bottom-color: #007bff;
            color: #007bff;
        }

        .modal-tab-content {
            display: none;
        }

        .modal-tab-content.active {
            display: block;
        }

        .link-controls {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .generated-link {
            margin-top: 12px;
            padding: 12px;
            background: #e8f5e9;
            border: 1px solid #4caf50;
            border-radius: 6px;
            display: none;
        }

        .link-text {
            word-break: break-all;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2e7d32;
            font-size: 0.9em;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1024px) {
            .content {
                grid-template-columns: 1fr;
            }
            
            .preview-section {
                max-height: none;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .status-bar {
                flex-direction: column;
                gap: 12px;
                text-align: center;
            }
            
            .subject-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .controls {
                justify-content: center;
            }
            
            .action-buttons {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>å¤šç­çº§ä½œä¸šç®¡ç†ç³»ç»Ÿ</h1>
            <div class="subtitle">æ•™å¸ˆç«¯ - ç®€æ´æ“ä½œç‰ˆ</div>
        </div>

        <div class="status-bar">
            <div class="sync-status">
                <div class="sync-indicator"></div>
                <span id="syncStatus">æ­£åœ¨è¿æ¥äº‘ç«¯...</span>
            </div>
            <div class="controls">
                <button class="btn btn-primary" onclick="loadHomeworkData()">
                    ğŸ“¥ åŠ è½½ä½œä¸š
                </button>
                <button class="btn btn-success" onclick="saveAll()">
                    ğŸ’¾ ä¿å­˜å…¨éƒ¨
                </button>
                <button class="btn btn-primary" onclick="showConfigModal()">
                    âš™ï¸ è®¾ç½®
                </button>
            </div>
        </div>

        <div class="content">
            <div class="editor-section">
                <h2 class="section-title">ä½œä¸šç¼–è¾‘</h2>
                
                <!-- ç­çº§é€‰æ‹©åŒºåŸŸ -->
                <div class="class-selector">
                    <h3>é€‰æ‹©ç­çº§ï¼š</h3>
                    <div class="grade-tabs" id="gradeTabs">
                        <button class="grade-tab active" data-grade="åˆä¸€">åˆä¸€å¹´çº§ (26ä¸ªç­)</button>
                        <button class="grade-tab" data-grade="åˆäºŒ">åˆäºŒå¹´çº§ (23ä¸ªç­)</button>
                        <button class="grade-tab" data-grade="åˆä¸‰">åˆä¸‰å¹´çº§ (23ä¸ªç­)</button>
                    </div>
                    <div class="class-buttons" id="classButtons">
                        <!-- ç­çº§æŒ‰é’®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- ç§‘ç›®é€‰æ‹©åŒºåŸŸ -->
                <div class="subject-selector">
                    <h3>é€‰æ‹©ç§‘ç›®ï¼š</h3>
                    <div class="subject-buttons" id="subjectButtons">
                        <!-- ç§‘ç›®æŒ‰é’®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <!-- ä½œä¸šç¼–è¾‘åŒºåŸŸ -->
                <div class="editor-container">
                    <label class="editor-label" id="editorLabel">è¯­æ–‡ä½œä¸šå†…å®¹ï¼š</label>
                    <textarea 
                        class="homework-editor" 
                        id="homeworkEditor"
                        placeholder="è¯·è¾“å…¥ä½œä¸šå†…å®¹...ï¼ˆæ”¯æŒå¤šè¡Œè¾“å…¥ï¼‰"
                    ></textarea>
                </div>

                <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ -->
                <div class="action-buttons">
                    <button class="btn btn-success" onclick="saveCurrent()">
                        ğŸ’¾ ä¿å­˜å½“å‰ç§‘ç›®
                    </button>
                    <button class="btn btn-warning" onclick="copyToAllClasses()">
                        ğŸ“‹ å¤åˆ¶åˆ°åŒå¹´çº§æ‰€æœ‰ç­çº§
                    </button>
                    <button class="btn btn-danger" onclick="clearCurrent()">
                        ğŸ—‘ï¸ æ¸…ç©ºå½“å‰ç§‘ç›®
                    </button>
                </div>
            </div>

            <div class="preview-section">
                <h2 class="section-title">å®æ—¶é¢„è§ˆ</h2>
                <div id="previewContainer">
                    <!-- é¢„è§ˆå†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div class="last-updated" id="lastUpdated">
                    <!-- æœ€åæ›´æ–°æ—¶é—´ -->
                </div>
            </div>
        </div>
    </div>

    <!-- é€šçŸ¥æ¶ˆæ¯ -->
    <div class="notification" id="notification"></div>

    <!-- é…ç½®æ¨¡æ€æ¡† -->
    <div class="modal" id="configModal">
        <div class="modal-content">
            <h3 class="modal-title">ç³»ç»Ÿè®¾ç½®</h3>
            
            <div class="modal-tabs">
                <button class="modal-tab active" data-tab="storage">äº‘å­˜å‚¨è®¾ç½®</button>
                <button class="modal-tab" data-tab="links">ç­çº§é“¾æ¥ç”Ÿæˆ</button>
            </div>
            
            <!-- äº‘å­˜å‚¨è®¾ç½®æ ‡ç­¾é¡µ -->
            <div class="modal-tab-content active" id="storageTab">
                <div class="config-form">
                    <div class="form-group">
                        <label class="form-label">è…¾è®¯äº‘ SecretId</label>
                        <input type="text" class="form-input" id="secretId" 
                               placeholder="è¯·è¾“å…¥SecretId">
                    </div>
                    <div class="form-group">
                        <label class="form-label">è…¾è®¯äº‘ SecretKey</label>
                        <input type="password" class="form-input" id="secretKey" 
                               placeholder="è¯·è¾“å…¥SecretKey">
                    </div>
                    <div class="form-group">
                        <label class="form-label">å­˜å‚¨æ¡¶åç§°</label>
                        <input type="text" class="form-input" id="cosBucket" 
                               value="class-homework-1257663765" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">åœ°åŸŸ</label>
                        <input type="text" class="form-input" id="cosRegion" 
                               value="ap-beijing" readonly>
                    </div>
                    <div class="form-actions">
                        <button class="btn btn-warning" onclick="testConnection()">
                            ğŸ” æµ‹è¯•è¿æ¥
                        </button>
                        <button class="btn btn-success" onclick="saveConfig()">
                            ğŸ’¾ ä¿å­˜é…ç½®
                        </button>
                        <button class="btn btn-danger" onclick="hideConfigModal()">
                            âŒ å–æ¶ˆ
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- ç­çº§é“¾æ¥ç”Ÿæˆæ ‡ç­¾é¡µ -->
            <div class="modal-tab-content" id="linksTab">
                <div class="config-form">
                    <div class="form-group">
                        <label class="form-label">é€‰æ‹©å¹´çº§å’Œç­çº§ç”Ÿæˆå®¶é•¿ç«¯é“¾æ¥ï¼š</label>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <select class="form-input" id="linkGrade" style="flex: 1;">
                                <option value="åˆä¸€">åˆä¸€å¹´çº§</option>
                                <option value="åˆäºŒ">åˆäºŒå¹´çº§</option>
                                <option value="åˆä¸‰">åˆä¸‰å¹´çº§</option>
                            </select>
                            <select class="form-input" id="linkClass" style="flex: 1;">
                                <!-- ç­çº§é€‰é¡¹åŠ¨æ€ç”Ÿæˆ -->
                            </select>
                        </div>
                    </div>
                    <div class="link-controls">
                        <button class="btn btn-success" onclick="generateClassLink()">
                            ğŸ”— ç”Ÿæˆç­çº§é“¾æ¥
                        </button>
                        <button class="btn btn-info" onclick="generateAllClassLinks()">
                            ğŸ“‹ ç”Ÿæˆæ‰€æœ‰ç­çº§é“¾æ¥
                        </button>
                    </div>
                    <div class="generated-link" id="generatedLink">
                        <div class="link-text" id="classLinkText"></div>
                        <div style="display: flex; gap: 8px;">
                            <button class="btn btn-success" onclick="copyClassLink()">
                                ğŸ“‹ å¤åˆ¶é“¾æ¥
                            </button>
                            <button class="btn btn-primary" onclick="testClassLink()">
                                ğŸ” æµ‹è¯•é“¾æ¥
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let homeworkData = null;
        let currentSubject = 'è¯­æ–‡';
        let currentGrade = 'åˆä¸€';
        let currentClass = '1ç­';
        
        // å­˜å‚¨æ¡¶é…ç½®
        const COS_CONFIG = {
            bucket: 'class-homework-1257663765',
            region: 'ap-beijing'
        };
        
        let config = {
            secretId: 'AKIDXsyve7LJ4bu0wc4GExue8PRDvOcaIm36',
            secretKey: 'tXw61g5FBsKZYIm10jDTYO4UfaGgqlQp',
            ...COS_CONFIG
        };

        // å¹´çº§ç­çº§é…ç½®
        const gradeConfig = {
            'åˆä¸€': 26,
            'åˆäºŒ': 23,
            'åˆä¸‰': 23
        };

        // ç§‘ç›®åˆ—è¡¨
        const subjects = [
            { id: 'è¯­æ–‡', name: 'è¯­æ–‡' },
            { id: 'æ•°å­¦', name: 'æ•°å­¦' },
            { id: 'è‹±è¯­', name: 'è‹±è¯­' },
            { id: 'ç§‘å­¦', name: 'ç§‘å­¦' },
            { id: 'é“æ³•', name: 'é“æ³•' },
            { id: 'ç¤¾ä¼š', name: 'ç¤¾ä¼š' },
            { id: 'æ™¨è¯»', name: 'æ™¨è¯»' }
        ];

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        // åˆå§‹åŒ–åº”ç”¨
        function initializeApp() {
            loadConfig();
            initializeGradeTabs();
            initializeClassButtons();
            initializeSubjectButtons();
            initializeLinkGenerator();
            initializeModalTabs();
            loadHomeworkData();
        }

        // åˆå§‹åŒ–å¹´çº§æ ‡ç­¾
        function initializeGradeTabs() {
            const container = document.getElementById('gradeTabs');
            
            container.addEventListener('click', function(e) {
                if (e.target.classList.contains('grade-tab')) {
                    document.querySelectorAll('.grade-tab').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    e.target.classList.add('active');
                    
                    currentGrade = e.target.dataset.grade;
                    initializeClassButtons();
                    initializeLinkClassOptions();
                    loadCurrentClassContent();
                }
            });
        }

        // åˆå§‹åŒ–ç­çº§æŒ‰é’®
        function initializeClassButtons() {
            const container = document.getElementById('classButtons');
            const classCount = gradeConfig[currentGrade];
            let html = '';
            
            for (let i = 1; i <= classCount; i++) {
                const classId = `${i}ç­`;
                const isActive = currentClass === classId && currentGrade === currentGrade;
                html += `
                    <button class="class-btn ${isActive ? 'active' : ''}" 
                            onclick="switchClass('${classId}')">
                        ${classId}
                    </button>
                `;
            }
            
            container.innerHTML = html;
        }

        // åˆå§‹åŒ–é“¾æ¥ç”Ÿæˆå™¨
        function initializeLinkGenerator() {
            initializeLinkClassOptions();
            
            document.getElementById('linkGrade').addEventListener('change', function() {
                initializeLinkClassOptions();
            });
        }

        // åˆå§‹åŒ–é“¾æ¥ç”Ÿæˆå™¨çš„ç­çº§é€‰é¡¹
        function initializeLinkClassOptions() {
            const grade = document.getElementById('linkGrade').value;
            const classCount = gradeConfig[grade];
            const classSelect = document.getElementById('linkClass');
            
            let html = '';
            for (let i = 1; i <= classCount; i++) {
                html += `<option value="${i}">${i}ç­</option>`;
            }
            
            classSelect.innerHTML = html;
        }

        // åˆå§‹åŒ–ç§‘ç›®æŒ‰é’®
        function initializeSubjectButtons() {
            const container = document.getElementById('subjectButtons');
            let html = '';
            
            subjects.forEach(subject => {
                const isActive = subject.id === currentSubject;
                html += `
                    <button class="subject-btn ${isActive ? 'active' : ''}" 
                            onclick="switchSubject('${subject.id}')">
                        ${subject.name}
                    </button>
                `;
            });
            
            container.innerHTML = html;
        }

        // åˆå§‹åŒ–æ¨¡æ€æ¡†æ ‡ç­¾é¡µ
        function initializeModalTabs() {
            const tabs = document.querySelectorAll('.modal-tab');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.dataset.tab;
                    
                    // æ›´æ–°æ´»åŠ¨æ ‡ç­¾
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // æ˜¾ç¤ºå¯¹åº”å†…å®¹
                    document.querySelectorAll('.modal-tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(`${tabId}Tab`).classList.add('active');
                });
            });
        }

        // ç”Ÿæˆç­çº§é“¾æ¥
        function generateClassLink() {
            const grade = document.getElementById('linkGrade').value;
            const classNum = document.getElementById('linkClass').value;
            
            // è·å–å½“å‰é¡µé¢çš„åŸºç¡€URL
            const baseUrl = window.location.href.split('?')[0];
            const parentPage = baseUrl.replace('teacher', 'parent') || baseUrl.replace(/index\.html$/, 'parent.html');
            
            // ç”Ÿæˆå®¶é•¿ç«¯é“¾æ¥
            const parentUrl = `${parentPage}parent.html?grade=${encodeURIComponent(grade)}&class=${classNum}`;
            
            // æ˜¾ç¤ºç”Ÿæˆçš„é“¾æ¥
            document.getElementById('classLinkText').textContent = parentUrl;
            document.getElementById('generatedLink').style.display = 'block';
            
            showNotification(`å·²ç”Ÿæˆ${grade}${classNum}ç­å®¶é•¿ç«¯é“¾æ¥`, 'success');
        }

        // ç”Ÿæˆæ‰€æœ‰ç­çº§é“¾æ¥
        function generateAllClassLinks() {
            const baseUrl = window.location.href.split('?')[0];
            const parentPage = baseUrl.replace('teacher', 'parent') || baseUrl.replace(/teacher\.html$/, 'parent.html');
            
            let allLinks = '';
            Object.entries(gradeConfig).forEach(([grade, classCount]) => {
                allLinks += `${grade}:\n`;
                for (let i = 1; i <= classCount; i++) {
                    const link = `${parentPage}parent.html?grade=${encodeURIComponent(grade)}&class=${i}`;
                    allLinks += `${grade}${i}ç­: ${link}\n`;
                }
                allLinks += '\n';
            });
            
            // åœ¨æ–°çª—å£ä¸­æ˜¾ç¤ºæ‰€æœ‰é“¾æ¥
            const linksWindow = window.open('', '_blank');
            linksWindow.document.write(`
                <html>
                    <head><title>æ‰€æœ‰ç­çº§é“¾æ¥</title></head>
                    <body style="font-family: 'Microsoft YaHei'; padding: 20px;">
                        <h1>æ‰€æœ‰ç­çº§å®¶é•¿ç«¯é“¾æ¥</h1>
                        <pre style="background: #f5f5f5; padding: 20px; border-radius: 5px; white-space: pre-wrap;">${allLinks}</pre>
                        <button onclick="window.print()">æ‰“å°é“¾æ¥åˆ—è¡¨</button>
                    </body>
                </html>
            `);
        }

        // å¤åˆ¶ç­çº§é“¾æ¥
        function copyClassLink() {
            const linkText = document.getElementById('classLinkText').textContent;
            navigator.clipboard.writeText(linkText).then(() => {
                showNotification('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            }).catch(() => {
                // å¤‡ç”¨æ–¹æ¡ˆ
                const textArea = document.createElement('textarea');
                textArea.value = linkText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showNotification('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            });
        }

        // æµ‹è¯•ç­çº§é“¾æ¥
        function testClassLink() {
            const linkText = document.getElementById('classLinkText').textContent;
            window.open(linkText, '_blank');
        }

        // åˆ‡æ¢ç­çº§
        function switchClass(classId) {
            currentClass = classId;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.class-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // åŠ è½½å½“å‰ç­çº§çš„å†…å®¹
            loadCurrentClassContent();
        }

        // åˆ‡æ¢ç§‘ç›®
        function switchSubject(subjectId) {
            currentSubject = subjectId;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.subject-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // æ›´æ–°ç¼–è¾‘å™¨æ ‡ç­¾
            document.getElementById('editorLabel').textContent = 
                `${subjectId}ä½œä¸šå†…å®¹ï¼š`;
            
            // åŠ è½½å½“å‰ç§‘ç›®çš„å†…å®¹
            loadCurrentSubjectContent();
        }

        // åŠ è½½å½“å‰ç­çº§å†…å®¹
        function loadCurrentClassContent() {
            if (homeworkData && homeworkData[currentGrade] && 
                homeworkData[currentGrade][currentClass]) {
                const classData = homeworkData[currentGrade][currentClass];
                
                // åŠ è½½å½“å‰ç§‘ç›®å†…å®¹
                if (classData[currentSubject]) {
                    document.getElementById('homeworkEditor').value = classData[currentSubject];
                } else {
                    document.getElementById('homeworkEditor').value = '';
                }
            } else {
                document.getElementById('homeworkEditor').value = '';
            }
        }

        // åŠ è½½å½“å‰ç§‘ç›®å†…å®¹åˆ°ç¼–è¾‘å™¨
        function loadCurrentSubjectContent() {
            if (homeworkData && homeworkData[currentGrade] && 
                homeworkData[currentGrade][currentClass]) {
                const classData = homeworkData[currentGrade][currentClass];
                
                if (classData[currentSubject]) {
                    document.getElementById('homeworkEditor').value = classData[currentSubject];
                } else {
                    document.getElementById('homeworkEditor').value = '';
                }
            } else {
                document.getElementById('homeworkEditor').value = '';
            }
        }

        // ä»COSåŠ è½½ä½œä¸šæ•°æ®
        async function loadHomeworkData() {
            showLoading();
            updateSyncStatus('æ­£åœ¨åŠ è½½ä½œä¸šæ•°æ®...');
            
            try {
                const response = await fetch(
                    `https://${config.bucket}.cos.${config.region}.myqcloud.com/homework_data.json?t=${Date.now()}`,
                    {
                        method: 'GET',
                        mode: 'cors',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    }
                );
                
                if (!response.ok) {
                    throw new Error(`ç½‘ç»œé”™è¯¯: ${response.status}`);
                }
                
                homeworkData = await response.json();
                loadCurrentClassContent();
                updatePreview();
                updateSyncStatus('æ•°æ®åŠ è½½æˆåŠŸ');
                showNotification('ä½œä¸šæ•°æ®åŠ è½½æˆåŠŸ', 'success');
                
            } catch (error) {
                console.error('åŠ è½½ä½œä¸šæ•°æ®å¤±è´¥:', error);
                // å¦‚æœè¿œç¨‹åŠ è½½å¤±è´¥ï¼Œå°è¯•åŠ è½½æœ¬åœ°æ•°æ®
                loadLocalData();
            } finally {
                hideLoading();
            }
        }

        // åŠ è½½æœ¬åœ°æ•°æ®
        function loadLocalData() {
            const localData = localStorage.getItem('homeworkData');
            if (localData) {
                homeworkData = JSON.parse(localData);
                loadCurrentClassContent();
                updatePreview();
                updateSyncStatus('å·²åŠ è½½æœ¬åœ°å¤‡ä»½æ•°æ®');
                showNotification('å·²åŠ è½½æœ¬åœ°å¤‡ä»½æ•°æ®', 'warning');
            } else {
                // åˆå§‹åŒ–ç©ºæ•°æ®
                homeworkData = initializeEmptyData();
                updateSyncStatus('åˆå§‹åŒ–æ–°æ•°æ®');
            }
        }

        // åˆå§‹åŒ–ç©ºæ•°æ®
        function initializeEmptyData() {
            const data = {};
            
            Object.keys(gradeConfig).forEach(grade => {
                data[grade] = {};
                const classCount = gradeConfig[grade];
                
                for (let i = 1; i <= classCount; i++) {
                    const classId = `${i}ç­`;
                    data[grade][classId] = {
                        "è¯­æ–‡": "æš‚æ— ä½œä¸š",
                        "æ•°å­¦": "æš‚æ— ä½œä¸š",
                        "è‹±è¯­": "æš‚æ— ä½œä¸š",
                        "ç§‘å­¦": "æš‚æ— ä½œä¸š",
                        "é“æ³•": "æš‚æ— ä½œä¸š",
                        "ç¤¾ä¼š": "æš‚æ— ä½œä¸š",
                        "æ™¨è¯»": "æš‚æ— æ™¨è¯»ä»»åŠ¡",
                        "last_updated": new Date().toLocaleString('zh-CN')
                    };
                }
            });
            
            return data;
        }

        // ä¿å­˜æ‰€æœ‰å†…å®¹
        async function saveAll() {
            if (!homeworkData) return;
            
            // ç¡®ä¿æ•°æ®ç»“æ„å­˜åœ¨
            if (!homeworkData[currentGrade]) {
                homeworkData[currentGrade] = {};
            }
            if (!homeworkData[currentGrade][currentClass]) {
                homeworkData[currentGrade][currentClass] = {};
            }
            
            // ç¡®ä¿æ‰€æœ‰ç§‘ç›®éƒ½æœ‰æœ€æ–°å†…å®¹
            const content = document.getElementById('homeworkEditor').value.trim();
            
            homeworkData[currentGrade][currentClass][currentSubject] = content || 'æš‚æ— ä½œä¸š';
            homeworkData[currentGrade][currentClass].last_updated = new Date().toLocaleString('zh-CN');
            
            updatePreview();
            
            // å…ˆä¿å­˜åˆ°æœ¬åœ°
            localStorage.setItem('homeworkData', JSON.stringify(homeworkData));
            
            // ç„¶åå°è¯•ä¸Šä¼ åˆ°äº‘ç«¯
            updateSyncStatus('æ­£åœ¨ä¸Šä¼ åˆ°äº‘ç«¯...');
            
            try {
                const result = await uploadToCOS(homeworkData);
                
                if (result.success) {
                    updateSyncStatus('äº‘ç«¯ä¿å­˜æˆåŠŸ');
                    showNotification(`${currentGrade}${currentClass}ä½œä¸šå·²ä¿å­˜åˆ°æœ¬åœ°å’Œäº‘ç«¯ï¼å­¦ç”Ÿç«¯å°†è‡ªåŠ¨æ›´æ–°`, 'success');
                } else {
                    updateSyncStatus('äº‘ç«¯ä¿å­˜å¤±è´¥ï¼Œå·²ä¿å­˜åˆ°æœ¬åœ°');
                    showNotification('ä½œä¸šå·²ä¿å­˜åˆ°æœ¬åœ°ï¼Œä½†äº‘ç«¯ä¸Šä¼ å¤±è´¥: ' + result.message, 'warning');
                }
            } catch (error) {
                updateSyncStatus('äº‘ç«¯ä¿å­˜å¤±è´¥ï¼Œå·²ä¿å­˜åˆ°æœ¬åœ°');
                showNotification('ä½œä¸šå·²ä¿å­˜åˆ°æœ¬åœ°ï¼Œä½†äº‘ç«¯ä¸Šä¼ å¤±è´¥: ' + error.message, 'warning');
            }
        }

        // ä¿å­˜å½“å‰ç§‘ç›®
        async function saveCurrent() {
            if (!homeworkData) return;
            
            // ç¡®ä¿æ•°æ®ç»“æ„å­˜åœ¨
            if (!homeworkData[currentGrade]) {
                homeworkData[currentGrade] = {};
            }
            if (!homeworkData[currentGrade][currentClass]) {
                homeworkData[currentGrade][currentClass] = {};
            }
            
            const content = document.getElementById('homeworkEditor').value.trim();
            homeworkData[currentGrade][currentClass][currentSubject] = content || 'æš‚æ— ä½œä¸š';
            homeworkData[currentGrade][currentClass].last_updated = new Date().toLocaleString('zh-CN');
            
            updatePreview();
            
            // å…ˆä¿å­˜åˆ°æœ¬åœ°
            localStorage.setItem('homeworkData', JSON.stringify(homeworkData));
            
            // ç„¶åå°è¯•ä¸Šä¼ åˆ°äº‘ç«¯
            updateSyncStatus('æ­£åœ¨ä¸Šä¼ åˆ°äº‘ç«¯...');
            
            try {
                const result = await uploadToCOS(homeworkData);
                
                if (result.success) {
                    updateSyncStatus('äº‘ç«¯ä¿å­˜æˆåŠŸ');
                    showNotification(`${currentGrade}${currentClass}${currentSubject}ä½œä¸šå·²ä¿å­˜åˆ°æœ¬åœ°å’Œäº‘ç«¯ï¼`, 'success');
                } else {
                    updateSyncStatus('äº‘ç«¯ä¿å­˜å¤±è´¥ï¼Œå·²ä¿å­˜åˆ°æœ¬åœ°');
                    showNotification(`${currentSubject}ä½œä¸šå·²ä¿å­˜åˆ°æœ¬åœ°ï¼Œä½†äº‘ç«¯ä¸Šä¼ å¤±è´¥: ` + result.message, 'warning');
                }
            } catch (error) {
                updateSyncStatus('äº‘ç«¯ä¿å­˜å¤±è´¥ï¼Œå·²ä¿å­˜åˆ°æœ¬åœ°');
                showNotification(`${currentSubject}ä½œä¸šå·²ä¿å­˜åˆ°æœ¬åœ°ï¼Œä½†äº‘ç«¯ä¸Šä¼ å¤±è´¥: ` + error.message, 'warning');
            }
        }

        // å¤åˆ¶åˆ°åŒå¹´çº§æ‰€æœ‰ç­çº§
        function copyToAllClasses() {
            if (!homeworkData) return;
            
            const content = document.getElementById('homeworkEditor').value.trim();
            const classCount = gradeConfig[currentGrade];
            
            if (confirm(`ç¡®å®šè¦å°†å½“å‰å†…å®¹å¤åˆ¶åˆ°${currentGrade}æ‰€æœ‰${classCount}ä¸ªç­çº§å—ï¼Ÿ`)) {
                for (let i = 1; i <= classCount; i++) {
                    const classId = `${i}ç­`;
                    
                    // ç¡®ä¿æ•°æ®ç»“æ„å­˜åœ¨
                    if (!homeworkData[currentGrade][classId]) {
                        homeworkData[currentGrade][classId] = {};
                    }
                    
                    homeworkData[currentGrade][classId][currentSubject] = content || 'æš‚æ— ä½œä¸š';
                    homeworkData[currentGrade][classId].last_updated = new Date().toLocaleString('zh-CN');
                }
                
                updatePreview();
                showNotification(`å·²æˆåŠŸå¤åˆ¶åˆ°${currentGrade}æ‰€æœ‰${classCount}ä¸ªç­çº§`, 'success');
            }
        }

        // ä¸Šä¼ åˆ°è…¾è®¯äº‘COS
        async function uploadToCOS(data) {
            const jsonData = JSON.stringify(data, null, 2);
            
            try {
                console.log('å¼€å§‹ç›´æ¥ä¸Šä¼ åˆ°COS...');
                
                // æ–¹æ³•1: ç›´æ¥PUTè¯·æ±‚
                const response = await fetch(
                    `https://${config.bucket}.cos.${config.region}.myqcloud.com/homework_data.json`,
                    {
                        method: 'PUT',
                        mode: 'cors',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: jsonData
                    }
                );
                
                console.log('ç›´æ¥ä¸Šä¼ å“åº”çŠ¶æ€:', response.status);
                
                if (response.ok) {
                    return { success: true, message: 'ç›´æ¥ä¸Šä¼ æˆåŠŸ' };
                } else {
                    // å¦‚æœç›´æ¥PUTå¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹æ³•
                    return await tryAlternativeUploadMethods(data);
                }
            } catch (error) {
                console.error('ç›´æ¥ä¸Šä¼ é”™è¯¯:', error);
                return { success: false, message: error.message };
            }
        }

        // å¤‡é€‰ä¸Šä¼ æ–¹æ³•
        async function tryAlternativeUploadMethods(data) {
            showNotification('æ­£åœ¨å°è¯•å¤‡é€‰ä¸Šä¼ æ–¹æ¡ˆ...', 'warning');
            
            // æ–¹æ³•2: ä½¿ç”¨FormData
            try {
                const formData = new FormData();
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                formData.append('file', blob, 'homework_data.json');
                
                const response = await fetch(
                    `https://${config.bucket}.cos.${config.region}.myqcloud.com/`,
                    {
                        method: 'POST',
                        body: formData
                    }
                );
                
                if (response.ok) {
                    return { success: true, message: 'FormDataä¸Šä¼ æˆåŠŸ' };
                }
            } catch (error) {
                console.log('FormDataä¸Šä¼ å¤±è´¥:', error);
            }
            
            // æ–¹æ³•3: ä½¿ç”¨XMLHttpRequest
            try {
                return await uploadViaXHR(data);
            } catch (error) {
                console.log('XHRä¸Šä¼ å¤±è´¥:', error);
            }
            
            // æ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥
            return { 
                success: false, 
                message: 'æ‰€æœ‰ä¸Šä¼ æ–¹æ³•éƒ½å¤±è´¥äº†ã€‚è¯·æ£€æŸ¥ï¼š1. å­˜å‚¨æ¡¶æƒé™è®¾ç½® 2. CORSé…ç½® 3. ç½‘ç»œè¿æ¥' 
            };
        }

        // ä½¿ç”¨XMLHttpRequestä¸Šä¼ 
        function uploadViaXHR(data) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                const url = `https://${config.bucket}.cos.${config.region}.myqcloud.com/homework_data.json`;
                
                xhr.open('PUT', url, true);
                xhr.setRequestHeader('Content-Type', 'application/json');
                
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            resolve({ success: true, message: 'XHRä¸Šä¼ æˆåŠŸ' });
                        } else {
                            reject(new Error(`XHRä¸Šä¼ å¤±è´¥: ${xhr.status}`));
                        }
                    }
                };
                
                xhr.onerror = function() {
                    reject(new Error('XHRç½‘ç»œé”™è¯¯'));
                };
                
                xhr.send(JSON.stringify(data, null, 2));
            });
        }

        // æ¸…ç©ºå½“å‰ç§‘ç›®
        function clearCurrent() {
            if (confirm(`ç¡®å®šè¦æ¸…ç©º${currentSubject}ç§‘ç›®çš„ä½œä¸šå†…å®¹å—ï¼Ÿ`)) {
                homeworkData[currentGrade][currentClass][currentSubject] = 'æš‚æ— ä½œä¸š';
                document.getElementById('homeworkEditor').value = '';
                updatePreview();
                showNotification(`${currentSubject}å†…å®¹å·²æ¸…ç©º`, 'warning');
            }
        }

        // æ›´æ–°é¢„è§ˆ
        function updatePreview() {
            if (!homeworkData) return;
            
            const container = document.getElementById('previewContainer');
            let html = '';
            
            // åªæ˜¾ç¤ºå½“å‰ç­çº§çš„é¢„è§ˆ
            if (homeworkData[currentGrade] && homeworkData[currentGrade][currentClass]) {
                const classData = homeworkData[currentGrade][currentClass];
                
                subjects.forEach(subject => {
                    const content = classData[subject.id] || 'æš‚æ— å†…å®¹';
                    const isEmpty = !content || content === 'æš‚æ— ä½œä¸š' || content === 'æš‚æ— æ™¨è¯»ä»»åŠ¡';
                    
                    html += `
                        <div class="preview-card">
                            <div class="preview-header">
                                <h3>${subject.name}</h3>
                                <span class="preview-class">${currentGrade}${currentClass}</span>
                            </div>
                            <div class="preview-content">
                                ${isEmpty ? 
                                    `<div class="empty-preview">${subject.id === 'æ™¨è¯»' ? 'æš‚æ— æ™¨è¯»ä»»åŠ¡' : 'æš‚æ— ä½œä¸š'}</div>` :
                                    `<div class="preview-text">${escapeHtml(content)}</div>`
                                }
                            </div>
                        </div>
                    `;
                });
            } else {
                html = '<div class="empty-preview">æš‚æ— æ•°æ®</div>';
            }
            
            container.innerHTML = html;
            
            // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
            if (homeworkData[currentGrade] && homeworkData[currentGrade][currentClass]) {
                document.getElementById('lastUpdated').textContent = 
                    `æœ€åæ›´æ–°: ${homeworkData[currentGrade][currentClass].last_updated || 'æœªçŸ¥æ—¶é—´'}`;
            } else {
                document.getElementById('lastUpdated').textContent = 'æœ€åæ›´æ–°: æœªçŸ¥æ—¶é—´';
            }
        }

        // é…ç½®ç›¸å…³åŠŸèƒ½
        function loadConfig() {
            const savedConfig = localStorage.getItem('cosConfig');
            if (savedConfig) {
                config = { ...config, ...JSON.parse(savedConfig) };
            }
        }

        function saveConfig() {
            config.secretId = document.getElementById('secretId').value;
            config.secretKey = document.getElementById('secretKey').value;
            
            localStorage.setItem('cosConfig', JSON.stringify(config));
            hideConfigModal();
            showNotification('é…ç½®å·²ä¿å­˜', 'success');
        }

        function showConfigModal() {
            document.getElementById('secretId').value = config.secretId;
            document.getElementById('secretKey').value = config.secretKey;
            document.getElementById('configModal').classList.add('show');
        }

        function hideConfigModal() {
            document.getElementById('configModal').classList.remove('show');
        }

        async function testConnection() {
            try {
                showNotification('æ­£åœ¨æµ‹è¯•è¿æ¥...', 'warning');
                
                const response = await fetch(
                    `https://${config.bucket}.cos.${config.region}.myqcloud.com/homework_data.json`,
                    {
                        method: 'HEAD',
                        mode: 'cors'
                    }
                );
                
                if (response.status === 200 || response.status === 404) {
                    showNotification('è¿æ¥æµ‹è¯•æˆåŠŸï¼å­˜å‚¨æ¡¶å¯è®¿é—®', 'success');
                } else {
                    showNotification(`è¿æ¥æµ‹è¯•å¤±è´¥: ${response.status}`, 'error');
                }
            } catch (error) {
                showNotification('è¿æ¥æµ‹è¯•å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å·¥å…·å‡½æ•°
        function showLoading() {
            updateSyncStatus('åŠ è½½ä¸­...');
        }

        function hideLoading() {
            // çŠ¶æ€ä¼šåœ¨å…·ä½“æ“ä½œä¸­æ›´æ–°
        }

        function updateSyncStatus(message) {
            document.getElementById('syncStatus').textContent = message;
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification';
            notification.classList.add(type);
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(event) {
            if ((event.ctrlKey || event.metaKey) && event.key === 's') {
                event.preventDefault();
                saveAll();
            }
        });

        // æ·»åŠ è°ƒè¯•ä¿¡æ¯
        console.log('å¤šç­çº§ä½œä¸šç®¡ç†ç³»ç»Ÿå·²åˆå§‹åŒ–å®Œæˆ');
        console.log('å­˜å‚¨æ¡¶é…ç½®:', COS_CONFIG);
        console.log('å¹´çº§é…ç½®:', gradeConfig);
    </script>
</body>
</html>
